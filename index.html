<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ULPCHK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .hero-icon { color: #667eea; font-size: 3rem; margin-bottom: 1rem; }
    .result-line { font-family: "Courier New", monospace; white-space: pre-wrap; word-break: break-word; }
    .credit {
      max-width: 400px; margin: 0 auto;
      background: rgba(255 255 255 / 0.15);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: #f3f4f6;
      font-size: 0.9rem;
      font-weight: 600;
      display:flex; align-items:center; justify-content:center; gap:0.5rem;
      box-shadow: 0 4px 15px rgba(118,75,162,0.4); user-select:none;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center py-8 px-4">
  <div class="bg-white rounded-xl shadow-2xl p-10 max-w-3xl w-full mb-8">
    <div class="text-center mb-8">
      <i class="fas fa-search hero-icon"></i>
      <h1 class="text-4xl font-bold text-gray-800 mb-2">ULPCHK</h1>
      <p class="text-gray-600">Ingresar archivos ULP (Url:Log:Pass)</p>
    </div>

    <div class="mb-6">
      <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-file-alt mr-2 text-blue-500"></i> Selecciona un archivo TXT:
      </label>
      <input type="file" id="fileInput" accept=".txt"
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-300" />
    </div>

    <div class="mb-6">
      <label for="keywordInput" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-keyboard mr-2 text-green-500"></i> Palabra clave:
      </label>
      <input type="text" id="keywordInput" placeholder="Ingresa la palabra clave"
             class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300" />
    </div>

    <div class="mb-6">
      <label for="outputFileNameInput" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-file-export mr-2 text-purple-500"></i> Nombre del archivo de resultados (opcional):
      </label>
      <input type="text" id="outputFileNameInput" placeholder="Ej: mis_resultados_filtrados"
             class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-300" />
      <p class="text-gray-500 text-xs mt-1">Si no se especifica, se usará un nombre por defecto.</p>
    </div>

    <div class="flex justify-center mb-6 gap-4">
      <button id="searchBtn" disabled
              class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105">
        <i class="fas fa-search mr-2"></i>Buscar
      </button>
    </div>

    <div id="downloadSection" class="mb-6 text-center" style="display:none">
      <button id="downloadBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        <i class="fas fa-download mr-2"></i>Descargar Resultados
      </button>
    </div>

    <!-- Borrar resultados (oculto hasta que haya resultados) -->
    <div id="clearResultsSection" class="flex justify-center mb-6" style="display:none">
      <button id="clearResultsBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        <i class="fas fa-trash-alt mr-2"></i>Borrar Resultados
      </button>
    </div>

    <div id="results" class="bg-gray-50 p-4 rounded-md min-h-32 border border-gray-200">
      <p class="text-gray-500 text-center">Los resultados aparecerán aquí...</p>
    </div>
  </div>

  <!-- SECCIÓN PARA ELIMINAR DUPLICADOS -->
  <div class="bg-white rounded-xl shadow-2xl p-10 max-w-3xl w-full mt-8">
    <div class="text-center mb-8">
      <i class="fas fa-eraser hero-icon" style="color:#ef4444"></i>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Eliminar Duplicados</h2>
      <p class="text-gray-600">Sube un archivo TXT para eliminar líneas duplicadas.</p>
    </div>

    <div class="mb-6">
      <label for="deduplicateFileInput" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-file-upload mr-2 text-red-500"></i> Selecciona un archivo TXT para limpiar:
      </label>
      <input type="file" id="deduplicateFileInput" accept=".txt"
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 transition duration-300" />
    </div>

    <div class="mb-6">
      <label for="outputDeduplicateFileNameInput" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-file-signature mr-2 text-orange-500"></i> Nombre del archivo limpio (opcional):
      </label>
      <input type="text" id="outputDeduplicateFileNameInput" placeholder="Ej: mi_lista_limpia"
             class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 transition duration-300" />
      <p class="text-gray-500 text-xs mt-1">Si no se especifica, se usará un nombre por defecto.</p>
    </div>

    <div class="flex justify-center mb-6 gap-4">
      <button id="deduplicateBtn" disabled
              class="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105">
        <i class="fas fa-magic mr-2"></i>Limpiar Duplicados
      </button>
    </div>

    <div id="clearDeduplicateSection" class="flex justify-center mb-6" style="display:none">
      <button id="clearDeduplicateResultsBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        <i class="fas fa-trash-alt mr-2"></i>Borrar Resultados
      </button>
    </div>

    <div id="deduplicateResults" class="bg-gray-50 p-4 rounded-md min-h-32 border border-gray-200">
      <p class="text-gray-500 text-center">Los resultados de la limpieza aparecerán aquí...</p>
    </div>
  </div>

  <div class="credit" title="Diseño y desarrollo por falco(@ghost10080)">
    <svg xmlns="http://www.w3.org/2000/svg" fill="orange" viewBox="0 0 24 24" stroke="orange" stroke-width="1" width="20" height="20" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
    </svg>
    <span>Diseño y desarrollo por falco(@ghost10080)</span>
  </div>

  <script>
    // ---------- Utilidades ----------
    function escapeHtml(str) {
      if (!str && str !== "") return "";
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Elementos principales
      const fileInput = document.getElementById("fileInput");
      const keywordInput = document.getElementById("keywordInput");
      const outputFileNameInput = document.getElementById("outputFileNameInput");
      const searchBtn = document.getElementById("searchBtn");
      const downloadSection = document.getElementById("downloadSection");
      const downloadBtn = document.getElementById("downloadBtn");
      const resultsDiv = document.getElementById("results");
      const clearResultsSection = document.getElementById("clearResultsSection");
      const clearResultsBtn = document.getElementById("clearResultsBtn");

      const deduplicateFileInput = document.getElementById("deduplicateFileInput");
      const outputDeduplicateFileNameInput = document.getElementById("outputDeduplicateFileNameInput");
      const deduplicateBtn = document.getElementById("deduplicateBtn");
      const deduplicateResultsDiv = document.getElementById("deduplicateResults");
      const clearDeduplicateSection = document.getElementById("clearDeduplicateSection");
      const clearDeduplicateResultsBtn = document.getElementById("clearDeduplicateResultsBtn");

      let matchingLines = [];     // resultado búsqueda
      let dedupLines = [];        // resultado deduplicado

      // Inicializar estados
      function updateSearchButtonState() {
        const fileSelected = fileInput.files && fileInput.files.length > 0;
        const keywordEntered = keywordInput.value.trim() !== "";
        searchBtn.disabled = !(fileSelected && keywordEntered);
      }

      function updateDedupButtonState() {
        const fileSelected = deduplicateFileInput.files && deduplicateFileInput.files.length > 0;
        deduplicateBtn.disabled = !fileSelected;
      }

      updateSearchButtonState();
      updateDedupButtonState();

      // Eventos para habilitar botones
      fileInput.addEventListener("change", updateSearchButtonState);
      keywordInput.addEventListener("input", updateSearchButtonState);

      deduplicateFileInput.addEventListener("change", updateDedupButtonState);

      // ---------- BÚSQUEDA ----------
      searchBtn.addEventListener("click", () => {
        // reset UI mientras carga
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando...</p>';
        downloadSection.style.display = "none";
        clearResultsSection.style.display = "none";
        matchingLines = [];

        const file = fileInput.files[0];
        const keyword = keywordInput.value.trim().toLowerCase();
        const desiredName = outputFileNameInput.value.trim();

        if (!file || !keyword) {
          resultsDiv.innerHTML = '<p class="text-red-500 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Selecciona archivo y palabra clave.</p>';
          return;
        }

        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';

        const reader = new FileReader();
        reader.onload = (e) => {
          const rawText = e.target.result || "";
          // split by CRLF or LF (robusto)
          const lines = rawText.split(/\r?\n/);
          matchingLines = lines.filter(line => line.toLowerCase().includes(keyword));

          if (matchingLines.length > 0) {
            resultsDiv.innerHTML =
              `<h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center"><i class="fas fa-list mr-2 text-blue-500"></i>Líneas encontradas (${matchingLines.length}):</h3>` +
              matchingLines.map((line, idx) =>
                `<div class="mb-3"><pre class="bg-white p-3 rounded border text-sm overflow-auto result-line">${idx+1}. ${escapeHtml(line)}</pre></div>`
              ).join("");

            downloadSection.style.display = "block";
            clearResultsSection.style.display = "flex";

            // asignamos descarga (si se vuelve a asignar, se sobrescribe)
            downloadBtn.onclick = () => {
              const blob = new Blob([matchingLines.join("\n")], { type: "text/plain" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              let finalName = "resultados_ULPCHK.txt";
              if (desiredName) finalName = desiredName.endsWith(".txt") ? desiredName : (desiredName + ".txt");
              else finalName = `resultados_ULPCHK_${keyword}.txt`;
              a.download = finalName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            };
          } else {
            resultsDiv.innerHTML = '<p class="text-yellow-500 text-center"><i class="fas fa-search-minus mr-2"></i>No se encontraron líneas que contengan la palabra clave.</p>';
            downloadSection.style.display = "none";
            clearResultsSection.style.display = "none";
            matchingLines = [];
          }

          searchBtn.disabled = false;
          searchBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Buscar';
        };

        reader.onerror = () => {
          resultsDiv.innerHTML = '<p class="text-red-500 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Error al leer el archivo.</p>';
          downloadSection.style.display = "none";
          clearResultsSection.style.display = "none";
          searchBtn.disabled = false;
          searchBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Buscar';
          matchingLines = [];
        };

        reader.readAsText(file);
      });

      // ---------- BORRAR RESULTADOS (BÚSQUEDA) ----------
      clearResultsBtn.addEventListener("click", () => {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center">Los resultados aparecerán aquí...</p>';
        downloadSection.style.display = "none";
        clearResultsSection.style.display = "none";
        matchingLines = [];
      });

      // ---------- ELIMINAR DUPLICADOS ----------
      deduplicateBtn.addEventListener("click", () => {
        deduplicateResultsDiv.innerHTML = '<p class="text-gray-500 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Procesando...</p>';
        clearDeduplicateSection.style.display = "none";
        dedupLines = [];

        const file = deduplicateFileInput.files[0];
        const desiredName = outputDeduplicateFileNameInput.value.trim();

        if (!file) {
          deduplicateResultsDiv.innerHTML = '<p class="text-red-500 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Selecciona un archivo para deduplicar.</p>';
          return;
        }

        deduplicateBtn.disabled = true;
        deduplicateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Limpiando...';

        const reader = new FileReader();
        reader.onload = (e) => {
          const rawText = e.target.result || "";
          const lines = rawText.split(/\r?\n/);

          const originalLines = [];
          const normalizedSet = new Set();
          const finalUnique = [];

          lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed === "") return;
            originalLines.push(line);
            const norm = trimmed.toLowerCase();
            if (!normalizedSet.has(norm)) {
              normalizedSet.add(norm);
              finalUnique.push(line);
            }
          });

          const originalCount = originalLines.length;
          const uniqueCount = finalUnique.length;
          const removedCount = originalCount - uniqueCount;

          if (uniqueCount > 0) {
            deduplicateResultsDiv.innerHTML =
              `<h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center"><i class="fas fa-check-circle mr-2 text-green-500"></i>Proceso Completado:</h3>
              <p class="text-gray-700 mb-2">Líneas originales (no vacías): <span class="font-bold">${originalCount}</span></p>
              <p class="text-gray-700 mb-4">Líneas únicas: <span class="font-bold">${uniqueCount}</span> (Se eliminaron <span class="font-bold text-red-600">${removedCount}</span> duplicados)</p>
              <div class="text-center">
                <button id="downloadUniqueBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                  <i class="fas fa-download mr-2"></i>Descargar Archivo Limpio
                </button>
              </div>`;

            dedupLines = finalUnique;
            clearDeduplicateSection.style.display = "flex";

            // asignar click al botón recién creado
            const downloadUniqueBtn = document.getElementById("downloadUniqueBtn");
            downloadUniqueBtn.onclick = () => {
              const blob = new Blob([dedupLines.join("\n")], { type: "text/plain" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              let finalDedName = `ULPCHK_limpio_${file.name.replace(/\.txt$/i, "")}.txt`;
              if (desiredName) finalDedName = desiredName.endsWith(".txt") ? desiredName : (desiredName + ".txt");
              a.download = finalDedName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            };
          } else {
            deduplicateResultsDiv.innerHTML = '<p class="text-yellow-500 text-center"><i class="fas fa-info-circle mr-2"></i>El archivo está vacío o no contiene líneas válidas después de la limpieza.</p>';
            clearDeduplicateSection.style.display = "none";
            dedupLines = [];
          }

          deduplicateBtn.disabled = false;
          deduplicateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Limpiar Duplicados';
        };

        reader.onerror = () => {
          deduplicateResultsDiv.innerHTML = '<p class="text-red-500 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Error al leer el archivo.</p>';
          deduplicateBtn.disabled = false;
          deduplicateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Limpiar Duplicados';
          clearDeduplicateSection.style.display = "none";
          dedupLines = [];
        };

        reader.readAsText(file);
      });

      // ---------- BORRAR RESULTADOS (DEDUP) ----------
      clearDeduplicateResultsBtn.addEventListener("click", () => {
        deduplicateResultsDiv.innerHTML = '<p class="text-gray-500 text-center">Los resultados de la limpieza aparecerán aquí...</p>';
        clearDeduplicateSection.style.display = "none";
        dedupLines = [];
      });

    }); // DOMContentLoaded end
  </script>
</body>
</html>